<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Advanced Operations Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 2px solid #28a745;
        }

        .header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 25px;
            background: #f8f9fa;
        }

        .top-controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .control-row {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 220px;
        }

        .control-group label {
            font-weight: 700;
            color: #28a745;
            font-size: 16px;
        }

        select, input[type="month"], input[type="date"], input[type="text"] {
            padding: 15px 20px;
            border: 2px solid #28a745;
            border-radius: 10px;
            font-size: 18px;
            background: white;
            color: #333;
            min-height: 50px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 12px rgba(40, 167, 69, 0.3);
        }

        .landscape-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .landscape-controls select {
            flex: 1;
        }

        .add-landscape-btn {
            padding: 15px;
            background: #20c997;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            min-height: 50px;
        }

        .add-landscape-btn:hover {
            background: #17a2b8;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            background: #e9ecef;
            padding: 8px;
            border-radius: 30px;
            margin: 0 auto;
            width: fit-content;
            border: 2px solid #28a745;
        }

        .toggle-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            background: transparent;
            color: #666;
        }

        .toggle-btn.active {
            background: #28a745;
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s;
            min-height: 50px;
        }

        .btn-primary {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
        }

        .btn-primary:hover {
            background: #20c997;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #20c997;
            color: white;
            border: 2px solid #20c997;
        }

        .btn-success:hover {
            background: #17a2b8;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: 2px solid #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .legend-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .legend {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .legend-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .dot-green { background: #28a745; }
        .dot-amber { background: #ffc107; }
        .dot-red { background: #dc3545; }
        .dot-none { background: #f8f9fa; border-style: dashed; }

        .percentage-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .percentage-info h4 {
            color: #28a745;
            margin-bottom: 10px;
        }

        .percentage-info ul {
            list-style: none;
            padding: 0;
        }

        .percentage-info li {
            padding: 5px 0;
            font-weight: 500;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .summary-card {
            background: white;
            border: 3px solid #28a745;
            color: #28a745;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.15);
        }

        .summary-card.green { 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white;
        }

        .summary-card.amber { 
            background: linear-gradient(135deg, #ffc107, #ffb300); 
            color: white;
        }

        .summary-card.red { 
            background: linear-gradient(135deg, #dc3545, #c82333); 
            color: white;
        }

        .summary-card h3 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .summary-card p {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .view-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #28a745;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.1);
        }

        .grid-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            background: white;
        }

        .grid-table th {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 15px;
            text-align: center;
            border: 1px solid #20c997;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 100;
            font-size: 16px;
        }

        .grid-table th.skill-header {
            text-align: left;
            padding-left: 25px;
            min-width: 300px;
        }

        .grid-table td {
            border: 1px solid #dee2e6;
            padding: 15px;
            text-align: center;
            vertical-align: middle;
        }

        .grid-table td.skill-cell {
            background: #f8f9fa;
            font-weight: 700;
            text-align: left;
            padding-left: 25px;
            border-right: 4px solid #28a745;
            min-width: 300px;
            color: #28a745;
        }

        .status-cell {
            cursor: pointer;
            transition: all 0.3s;
            padding: 20px;
            position: relative;
        }

        .status-cell:hover {
            background: #e8f5e9;
            transform: scale(1.05);
        }

        .status-dot {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 4px solid #333;
            margin: 0 auto 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .status-dot:hover {
            transform: scale(1.3);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .status-dot.green {
            background: #28a745;
            border-color: #155724;
        }

        .status-dot.amber {
            background: #ffc107;
            border-color: #856404;
            color: #333;
        }

        .status-dot.red {
            background: #dc3545;
            border-color: #721c24;
        }

        .status-dot.none {
            background: #f8f9fa;
            border: 4px dashed #999;
            color: #999;
        }

        /* Weekly dropdown in monthly view */
        .weekly-dropdown {
            background: white;
            border: 2px solid #28a745;
            border-radius: 5px;
            padding: 5px;
            margin-top: 5px;
            font-size: 12px;
            cursor: pointer;
            max-width: 100px;
            margin: 5px auto 0;
        }

        .weekly-dropdown:hover {
            background: #f8f9fa;
        }

        .daily-indicators {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .daily-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #333;
            cursor: pointer;
            title: '';
        }

        .daily-indicator.green { background: #28a745; }
        .daily-indicator.amber { background: #ffc107; }
        .daily-indicator.red { background: #dc3545; }
        .daily-indicator.none { background: #f8f9fa; }

        /* Daily View Specific */
        .daily-container {
            padding: 25px;
        }

        .daily-stats {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #28a745;
        }

        .daily-grid {
            display: grid;
            grid-template-columns: 250px repeat(7, 1fr);
            gap: 3px;
            background: #e9ecef;
            padding: 25px;
            border-radius: 12px;
        }

        .daily-header {
            background: #28a745;
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: 700;
            border-radius: 5px;
        }

        .daily-skill {
            background: #20c997;
            color: white;
            padding: 20px;
            font-weight: 700;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }

        .daily-cell {
            background: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
            border: 2px solid transparent;
        }

        .daily-cell:hover {
            background: #e8f5e9;
            transform: scale(1.02);
            border-color: #28a745;
        }

        .percentage-value {
            font-size: 12px;
            font-weight: bold;
            color: #28a745;
            margin-top: 5px;
        }

        .downtime-display {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 35px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.3s ease-out;
            border: 3px solid #28a745;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #28a745;
        }

        .modal-header h3 {
            color: #28a745;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }

        .close-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: #28a745;
            font-size: 18px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid #28a745;
            border-radius: 10px;
            font-size: 18px;
            background: white;
            min-height: 50px;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .status-selection {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .status-button {
            flex: 1;
            padding: 20px;
            border: 4px solid transparent;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 16px;
            min-width: 150px;
        }

        .status-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-button.selected {
            border-color: #333;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn-green-select {
            background: #28a745;
            color: white;
        }

        .btn-amber-select {
            background: #ffc107;
            color: #333;
        }

        .btn-red-select {
            background: #dc3545;
            color: white;
        }

        .conditional-section {
            display: block;
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border-left: 5px solid #ffc107;
            border: 2px solid #ffc107;
        }

        .conditional-section h5 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .modal-actions {
            display: flex;
            gap: 20px;
            margin-top: 35px;
        }

        .modal-actions .btn {
            flex: 1;
            padding: 20px;
            font-size: 18px;
        }

        /* Skill Management */
        .skill-management {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 3px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .skill-management h4 {
            color: #28a745;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .add-skill-form {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .add-skill-form input {
            flex: 1;
            padding: 15px 20px;
            border: 3px solid #28a745;
            border-radius: 10px;
            font-size: 16px;
        }

        .skill-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .skill-tag {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .skill-remove {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        /* History Modal */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .history-table th {
            background: #28a745;
            color: white;
            padding: 20px;
            font-weight: 700;
            font-size: 16px;
        }

        .history-table td {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            font-size: 16px;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .edit-btn {
            background: #20c997;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .edit-btn:hover {
            background: #17a2b8;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                margin: 5px;
            }
            
            .grid-table {
                font-size: 14px;
            }
            
            .status-dot {
                width: 30px;
                height: 30px;
            }
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                min-width: unset;
                width: 100%;
            }

            .landscape-controls {
                flex-direction: column;
                gap: 15px;
            }

            select, input[type="month"], input[type="date"], input[type="text"] {
                font-size: 20px;
                padding: 18px 22px;
                min-height: 55px;
            }

            .summary-cards {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .modal-content {
                margin: 10px;
                padding: 25px;
                width: calc(100% - 20px);
                max-width: none;
            }

            .status-selection {
                flex-direction: column;
            }

            .modal-actions {
                flex-direction: column;
            }

            .legend {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .daily-grid {
                grid-template-columns: 200px repeat(7, 1fr);
                padding: 15px;
                font-size: 14px;
            }

            .daily-header, .daily-skill {
                padding: 15px 10px;
            }

            .btn {
                font-size: 18px;
                padding: 18px 25px;
            }

            .status-button {
                min-width: unset;
                flex: none;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>📊 Advanced Operations Dashboard</h1>
            <p>Integrated Daily & Monthly Tracking with Dynamic Percentage Calculation</p>
        </div>

        <div class="content">
            <!-- Top Controls -->
            <div class="top-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>🌍 Landscape:</label>
                        <div class="landscape-controls">
                            <select id="landscapeSelect">
                                <!-- Dynamically populated -->
                            </select>
                            <button class="add-landscape-btn" onclick="addNewLandscape()" title="Add New Landscape">➕</button>
                        </div>
                    </div>

                    <div class="control-group" id="monthControl">
                        <label>📅 Month:</label>
                        <input type="month" id="monthSelect">
                    </div>

                    <div class="control-group" id="dateControl" style="display: none;">
                        <label>📅 Date:</label>
                        <input type="date" id="dateSelect">
                    </div>

                    <div class="control-group">
                        <label>📊 View Mode:</label>
                        <div class="view-toggle">
                            <button class="toggle-btn active" onclick="switchView('monthly')">📊 Monthly</button>
                            <button class="toggle-btn" onclick="switchView('daily')">📅 Daily</button>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadCurrentView()">🔄 Refresh</button>
                    <button class="btn btn-success" onclick="showAddSkillModal()">➕ Add Skill</button>
                    <button class="btn btn-primary" onclick="exportToExcel()">📊 Export Excel Report</button>
                    <button class="btn btn-primary" onclick="importData()">📤 Import</button>
                    <button class="btn btn-primary" onclick="showHistoryModal()">📋 History</button>
                    <button class="btn btn-danger" onclick="clearCurrentData()">🗑️ Clear</button>
                </div>
            </div>

            <!-- Dynamic Percentage Info -->
            <div class="percentage-info">
                <h4>🤖 Dynamic Percentage Calculation (Downtime-Based)</h4>
                <ul>
                    <li>🟢 <strong>Green (95-100%):</strong> Minimal downtime (≤1.2 hours/day)</li>
                    <li>🟡 <strong>Amber (45-95%):</strong> Moderate downtime (1.2-13.2 hours/day)</li>
                    <li>🔴 <strong>Red (0-45%):</strong> High downtime (>13.2 hours/day)</li>
                    <li>📊 <strong>Monthly View:</strong> Shows weekly averages calculated from daily data</li>
                </ul>
            </div>

            <!-- Legend -->
            <div class="legend-section">
                <div class="legend">
                    <strong style="color: #28a745; font-size: 18px;">📌 Status Guide:</strong>
                    <div class="legend-item">
                        <div class="legend-dot dot-green"></div>
                        <span>Green - Optimal Performance (95-100%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot dot-amber"></div>
                        <span>Amber - Needs Attention (45-95%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot dot-red"></div>
                        <span>Red - Critical Issues (0-45%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot dot-none"></div>
                        <span>No Data Available (0%)</span>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h3 id="totalCount">0</h3>
                    <p>Total Entries</p>
                </div>
                <div class="summary-card green">
                    <h3 id="greenCount">0</h3>
                    <p>🟢 Optimal Performance</p>
                </div>
                <div class="summary-card amber">
                    <h3 id="amberCount">0</h3>
                    <p>🟡 Needs Attention</p>
                </div>
                <div class="summary-card red">
                    <h3 id="redCount">0</h3>
                    <p>🔴 Critical Issues</p>
                </div>
            </div>

            <!-- Skill Management -->
            <div class="skill-management">
                <h4>🛠️ Skill Management</h4>
                <p>Manage operational skills being tracked</p>
                <div class="add-skill-form">
                    <input type="text" id="newSkillInput" placeholder="Enter new skill name">
                    <button class="btn btn-success" onclick="addSkill()">Add Skill</button>
                </div>
                <div class="skill-list" id="skillList">
                    <!-- Skills displayed here -->
                </div>
            </div>

            <!-- Main View Container -->
            <div class="view-container">
                <!-- Monthly View -->
                <div id="monthlyView">
                    <table class="grid-table" id="monthlyTable">
                        <thead id="monthlyHeaders">
                            <!-- Headers generated dynamically -->
                        </thead>
                        <tbody id="monthlyBody">
                            <!-- Body generated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Daily View -->
                <div id="dailyView" style="display: none;">
                    <div class="daily-container">
                        <div class="daily-stats">
                            <h3 style="color: #28a745; margin-bottom: 15px;">📊 Daily Performance Statistics</h3>
                            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #28a745; font-weight: bold;" id="dailyCompletion">0%</div>
                                    <div style="font-weight: 600;">Today's Average</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #28a745; font-weight: bold;" id="weeklyAverage">0%</div>
                                    <div style="font-weight: 600;">Weekly Average</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #28a745; font-weight: bold;" id="trendIndicator">📈</div>
                                    <div style="font-weight: 600;">Performance Trend</div>
                                </div>
                            </div>
                        </div>
                        <div class="daily-grid" id="dailyGrid">
                            <!-- Daily grid generated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>✏️ Edit Entry</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>📋 Skill:</label>
                <input type="text" id="modalSkill" readonly>
            </div>
            
            <div class="form-group">
                <label>📅 Period:</label>
                <input type="text" id="modalPeriod" readonly>
            </div>
            
            <div class="form-group">
                <label>📅 Date:</label>
                <input type="date" id="modalDate">
            </div>

            <div id="conditionalFields" class="conditional-section">
                <h5>⏱️ Downtime Configuration (Determines Status & Percentage)</h5>
                <div class="form-group">
                    <label>⏱️ Downtime Hours (0-24):</label>
                    <input type="number" id="modalDowntime" step="0.5" min="0" max="24" placeholder="0.0" oninput="updateStatusFromDowntime()">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        • 0-1.2 hours: Green (95-100%)<br>
                        • 1.2-13.2 hours: Amber (45-95%)<br>
                        • 13.2+ hours: Red (0-45%)
                    </small>
                </div>
                <div class="form-group">
                    <label>🆔 Incident Number (if applicable):</label>
                    <input type="text" id="modalIncident" placeholder="INC123456">
                </div>
            </div>

            <div class="form-group">
                <label>📝 Notes:</label>
                <textarea id="modalNotes" rows="4" placeholder="Additional details and comments..."></textarea>
            </div>

            <div class="form-group">
                <label>📊 Calculated Performance (Auto-Calculated from Downtime):</label>
                <input type="text" id="modalPercentage" readonly style="background: #f8f9fa; cursor: not-allowed; font-weight: bold; font-size: 1.2rem;">
                <small style="color: #666; margin-top: 5px; display: block;">Percentage and status automatically calculated based on downtime hours.</small>
            </div>

            <div class="modal-actions">
                <button class="btn btn-success" onclick="saveEntry()">💾 Save</button>
                <button class="btn btn-danger" onclick="deleteEntry()">🗑️ Delete</button>
                <button class="btn btn-primary" onclick="closeModal()">❌ Cancel</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1200px;">
            <div class="modal-header">
                <h3>📋 Entry History - Click any entry to edit</h3>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="exportHistoryToExcel()">📊 Export History to Excel</button>
                <select id="historyFilter" onchange="filterHistory()" style="padding: 10px;">
                    <option value="">All Landscapes</option>
                    <!-- Dynamically populated -->
                </select>
            </div>

            <div style="max-height: 500px; overflow-y: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Landscape</th>
                            <th>Skill</th>
                            <th>Period</th>
                            <th>Status</th>
                            <th>Performance %</th>
                            <th>Downtime (h)</th>
                            <th>Incident</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History entries -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Landscape Modal -->
    <div id="addLandscapeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🌍 Add New Landscape</h3>
                <button class="close-btn" onclick="closeAddLandscapeModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>🏷️ Landscape Name:</label>
                <input type="text" id="newLandscapeName" placeholder="Enter landscape name (e.g., APAC, EMEA)">
            </div>

            <div class="modal-actions">
                <button class="btn btn-success" onclick="saveNewLandscape()">💾 Add Landscape</button>
                <button class="btn btn-primary" onclick="closeAddLandscapeModal()">❌ Cancel</button>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <script>
        // Global Variables
        let operationalData = JSON.parse(localStorage.getItem('operationalData')) || {};
        let skillsList = JSON.parse(localStorage.getItem('skillsList')) || [
            'Business Clarity',
            'Revenue',
            'BPT Processing',
            'Stock Aging',
            'Inventory',
            'AMB for Manufacturing',
            'PMI for Manufacturing',
            'BPM Stock Reconciliation'
        ];

        // Enhanced Landscapes with dynamic addition
        let landscapesList = JSON.parse(localStorage.getItem('landscapesList')) || [
            'Europe', 'NAM', 'IA', 'SEA', 'Global'
        ];

        let currentView = 'monthly';
        let currentLandscape = 'Europe';
        let currentMonth = new Date().toISOString().substring(0, 7);
        let currentDate = new Date().toISOString().split('T')[0];
        let editingKey = null;

        // Dynamic percentage calculation based on downtime hours
        function calculatePercentageFromDowntime(downtimeHours) {
            const downtime = parseFloat(downtimeHours) || 0;
            
            if (downtime <= 1.2) {
                // Green: 95-100%
                return Math.max(95, Math.round(100 - (downtime * 4.17))); // Linear scale from 100% to 95%
            } else if (downtime <= 13.2) {
                // Amber: 45-95%
                const range = 13.2 - 1.2; // 12 hours range
                const percentage = 95 - ((downtime - 1.2) / range) * 50; // Scale from 95% to 45%
                return Math.round(percentage);
            } else {
                // Red: 0-45%
                const maxDowntime = 24;
                const remaining = Math.max(0, maxDowntime - downtime);
                return Math.round((remaining / (maxDowntime - 13.2)) * 45);
            }
        }

        function getStatusFromPercentage(percentage) {
            if (percentage >= 95) return 'green';
            if (percentage >= 45) return 'amber';
            return 'red';
        }

        function updateStatusFromDowntime() {
            const downtime = parseFloat(document.getElementById('modalDowntime').value) || 0;
            const percentage = calculatePercentageFromDowntime(downtime);
            const status = getStatusFromPercentage(percentage);
            
            document.getElementById('modalPercentage').value = `${percentage}% (${status.toUpperCase()})`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeLandscapes();
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('dateSelect').value = currentDate;
            
            updateSkillList();
            loadCurrentView();
        });

        // Landscape Management
        function initializeLandscapes() {
            const landscapeSelect = document.getElementById('landscapeSelect');
            const historyFilter = document.getElementById('historyFilter');
            
            // Clear existing options
            landscapeSelect.innerHTML = '';
            if (historyFilter) {
                historyFilter.innerHTML = '<option value="">All Landscapes</option>';
            }
            
            // Populate landscapes
            landscapesList.forEach(landscape => {
                const option = document.createElement('option');
                option.value = landscape;
                option.textContent = landscape;
                landscapeSelect.appendChild(option);
                
                if (historyFilter) {
                    const filterOption = document.createElement('option');
                    filterOption.value = landscape;
                    filterOption.textContent = landscape;
                    historyFilter.appendChild(filterOption);
                }
            });
            
            // Set default
            landscapeSelect.value = currentLandscape;
        }

        function addNewLandscape() {
            document.getElementById('addLandscapeModal').style.display = 'block';
        }

        function closeAddLandscapeModal() {
            document.getElementById('addLandscapeModal').style.display = 'none';
            document.getElementById('newLandscapeName').value = '';
        }

        function saveNewLandscape() {
            const newLandscape = document.getElementById('newLandscapeName').value.trim();
            
            if (!newLandscape) {
                alert('❌ Please enter a landscape name!');
                return;
            }
            
            if (landscapesList.includes(newLandscape)) {
                alert('❌ Landscape already exists!');
                return;
            }
            
            // Add to list and save
            landscapesList.push(newLandscape);
            localStorage.setItem('landscapesList', JSON.stringify(landscapesList));
            
            // Update dropdowns
            initializeLandscapes();
            
            // Select new landscape
            document.getElementById('landscapeSelect').value = newLandscape;
            currentLandscape = newLandscape;
            
            closeAddLandscapeModal();
            loadCurrentView();
            alert(`✅ "${newLandscape}" landscape added successfully!`);
        }

        // View Management
        function switchView(view) {
            currentView = view;
            
            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide controls
            if (view === 'daily') {
                document.getElementById('monthControl').style.display = 'none';
                document.getElementById('dateControl').style.display = 'flex';
                document.getElementById('monthlyView').style.display = 'none';
                document.getElementById('dailyView').style.display = 'block';
            } else {
                document.getElementById('monthControl').style.display = 'flex';
                document.getElementById('dateControl').style.display = 'none';
                document.getElementById('monthlyView').style.display = 'block';
                document.getElementById('dailyView').style.display = 'none';
            }
            
            loadCurrentView();
        }

        function loadCurrentView() {
            currentLandscape = document.getElementById('landscapeSelect').value;
            
            if (currentView === 'monthly') {
                currentMonth = document.getElementById('monthSelect').value;
                generateMonthlyView();
            } else {
                currentDate = document.getElementById('dateSelect').value;
                generateDailyView();
            }
            
            updateSummaryCards();
        }

        // Weekly aggregation function
        function calculateWeeklyStatus(skill, weekDates) {
            let totalPercentage = 0;
            let validEntries = 0;
            
            weekDates.forEach(date => {
                const entryKey = `${currentLandscape}_${skill}_${date}`;
                const entry = operationalData[entryKey];
                if (entry) {
                    totalPercentage += entry.percentage || 0;
                    validEntries++;
                }
            });
            
            if (validEntries === 0) return { percentage: 0, status: 'none' };
            
            const avgPercentage = Math.round(totalPercentage / validEntries);
            const status = getStatusFromPercentage(avgPercentage);
            
            return { percentage: avgPercentage, status: status };
        }

        // Monthly View with weekly aggregation
        function generateMonthlyView() {
            const weeks = generateWeeksForMonth();
            createMonthlyHeaders(weeks);
            createMonthlyBody(weeks);
        }

        function generateWeeksForMonth() {
            const [year, month] = currentMonth.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            let weeks = [];
            let currentDate = new Date(firstDay);
            let weekNum = 1;

            while (currentDate <= lastDay) {
                const weekStart = new Date(currentDate);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(currentDate.getDate() + 6);
                
                // Get all dates in this week
                const weekDates = [];
                for (let d = new Date(weekStart); d <= weekEnd && d <= lastDay; d.setDate(d.getDate() + 1)) {
                    weekDates.push(d.toISOString().split('T')[0]);
                }
                
                weeks.push({
                    number: weekNum,
                    label: `WK ${weekNum}`,
                    start: weekStart.getDate(),
                    end: Math.min(weekEnd.getDate(), lastDay.getDate()),
                    dates: weekDates
                });
                
                currentDate.setDate(currentDate.getDate() + 7);
                weekNum++;
            }
            
            return weeks;
        }

        function createMonthlyHeaders(weeks) {
            let headerHTML = '<tr><th class="skill-header">Skills / Operational Areas</th>';
            
            weeks.forEach(week => {
                headerHTML += `<th>${week.label}<br><small>${week.start}-${week.end}</small></th>`;
            });
            
            headerHTML += '</tr>';
            document.getElementById('monthlyHeaders').innerHTML = headerHTML;
        }

        function createMonthlyBody(weeks) {
            let bodyHTML = '';
            
            skillsList.forEach(skill => {
                bodyHTML += `<tr><td class="skill-cell">${skill}</td>`;
                
                weeks.forEach(week => {
                    const weeklyData = calculateWeeklyStatus(skill, week.dates);
                    const statusClass = weeklyData.status;
                    const percentage = weeklyData.percentage;
                    
                    // Create daily indicators
                    let dailyIndicators = '<div class="daily-indicators">';
                    week.dates.forEach((date, index) => {
                        const entryKey = `${currentLandscape}_${skill}_${date}`;
                        const entry = operationalData[entryKey];
                        const dayStatus = entry ? getStatusFromPercentage(entry.percentage) : 'none';
                        const dayName = ['S','M','T','W','T','F','S'][new Date(date).getDay()];
                        
                        dailyIndicators += `
                            <div class="daily-indicator ${dayStatus}" 
                                 title="${dayName}: ${entry ? entry.percentage + '%' : 'No data'}" 
                                 onclick="goToDailyView('${date}')"></div>
                        `;
                    });
                    dailyIndicators += '</div>';
                    
                    bodyHTML += `
                        <td class="status-cell" onclick="editWeeklyEntry('${skill}', ${week.number}, '${JSON.stringify(week.dates).replace(/"/g, '&quot;')}')">
                            <div class="status-dot ${statusClass}" title="Click to view details - Week ${week.number}">
                                ${percentage}%
                            </div>
                            ${dailyIndicators}
                        </td>
                    `;
                });
                
                bodyHTML += '</tr>';
            });
            
            document.getElementById('monthlyBody').innerHTML = bodyHTML;
        }

        function goToDailyView(date) {
            // Switch to daily view and set the date
            document.getElementById('dateSelect').value = date;
            currentDate = date;
            switchView('daily');
            
            // Update toggle button
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.toggle-btn:last-child').classList.add('active');
        }

        function editWeeklyEntry(skill, weekNumber, weekDatesStr) {
            const weekDates = JSON.parse(weekDatesStr.replace(/&quot;/g, '"'));
            
            // Show options: View details or go to daily view
            const choice = confirm(`📊 Weekly Summary for ${skill} - Week ${weekNumber}\n\nClick OK to go to Daily View for editing\nClick Cancel to stay in Monthly View`);
            
            if (choice) {
                // Go to daily view with the first date of the week
                goToDailyView(weekDates[0]);
            }
        }

        // Daily View
        function generateDailyView() {
            const date = new Date(currentDate);
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let gridHTML = '<div class="daily-header">Skills</div>';
            
            // Create day headers
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(date);
                dayDate.setDate(date.getDate() - date.getDay() + i);
                gridHTML += `<div class="daily-header">${dayNames[i]}<br><small>${dayDate.getDate()}/${dayDate.getMonth() + 1}</small></div>`;
            }
            
            // Create skill rows
            skillsList.forEach(skill => {
                gridHTML += `<div class="daily-skill">${skill}</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(date);
                    dayDate.setDate(date.getDate() - date.getDay() + i);
                    const dateStr = dayDate.toISOString().split('T')[0];
                    const entryKey = `${currentLandscape}_${skill}_${dateStr}`;
                    const entry = operationalData[entryKey];
                    const statusClass = entry ? getStatusFromPercentage(entry.percentage) : 'none';
                    const percentage = entry ? entry.percentage : 0;
                    const downtime = entry ? entry.downtime || 0 : 0;
                    
                    gridHTML += `
                        <div class="daily-cell" onclick="editEntry('${entryKey}', '${skill}', '${dateStr}')">
                            <div class="status-dot ${statusClass}" title="Click to edit ${skill} - ${dateStr}">
                                ${entry ? '✓' : ''}
                            </div>
                            <div class="percentage-value">${percentage}%</div>
                            <div class="downtime-display">${downtime}h down</div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('dailyGrid').innerHTML = gridHTML;
            updateDailyStats();
        }

        function updateDailyStats() {
            const date = new Date(currentDate);
            let todayTotal = 0, todaySum = 0;
            let weekTotal = 0, weekSum = 0;

            // Today's stats
            const todayKey = currentDate;
            skillsList.forEach(skill => {
                const entryKey = `${currentLandscape}_${skill}_${todayKey}`;
                const entry = operationalData[entryKey];
                todayTotal++;
                if (entry) {
                    todaySum += entry.percentage || 0;
                }
            });

            // Week's stats
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(date);
                dayDate.setDate(date.getDate() - date.getDay() + i);
                const dateStr = dayDate.toISOString().split('T')[0];
                
                skillsList.forEach(skill => {
                    const entryKey = `${currentLandscape}_${skill}_${dateStr}`;
                    const entry = operationalData[entryKey];
                    weekTotal++;
                    if (entry) {
                        weekSum += entry.percentage || 0;
                    }
                });
            }

            const dailyCompletion = todayTotal > 0 ? Math.round(todaySum / todayTotal) : 0;
            const weeklyAverage = weekTotal > 0 ? Math.round(weekSum / weekTotal) : 0;
            const trend = dailyCompletion >= weeklyAverage ? '📈' : '📉';

            document.getElementById('dailyCompletion').textContent = `${dailyCompletion}%`;
            document.getElementById('weeklyAverage').textContent = `${weeklyAverage}%`;
            document.getElementById('trendIndicator').textContent = trend;
        }

        // Entry Management with Downtime-Based Calculation
        function editEntry(key, skill, period) {
            editingKey = key;
            const entry = operationalData[key] || {};
            
            document.getElementById('modalSkill').value = skill;
            document.getElementById('modalPeriod').value = period;
            document.getElementById('modalDate').value = entry.date || period;
            document.getElementById('modalNotes').value = entry.notes || '';
            document.getElementById('modalDowntime').value = entry.downtime || 0;
            document.getElementById('modalIncident').value = entry.incident || '';
            
            // Update percentage display
            updateStatusFromDowntime();
            
            document.getElementById('editModal').style.display = 'block';
        }

        function saveEntry() {
            const downtime = parseFloat(document.getElementById('modalDowntime').value) || 0;
            const percentage = calculatePercentageFromDowntime(downtime);
            const status = getStatusFromPercentage(percentage);
            
            const entry = {
                status: status,
                date: document.getElementById('modalDate').value,
                notes: document.getElementById('modalNotes').value || '',
                percentage: percentage,
                downtime: downtime,
                incident: document.getElementById('modalIncident').value || '',
                landscape: currentLandscape,
                skill: document.getElementById('modalSkill').value,
                period: document.getElementById('modalPeriod').value,
                timestamp: new Date().toISOString()
            };
            
            operationalData[editingKey] = entry;
            localStorage.setItem('operationalData', JSON.stringify(operationalData));
            
            closeModal();
            loadCurrentView(); // This will refresh both views and sync them
            alert('✅ Entry saved successfully with calculated percentage and status!');
        }

        function deleteEntry() {
            if (confirm('🗑️ Delete this entry?')) {
                delete operationalData[editingKey];
                localStorage.setItem('operationalData', JSON.stringify(operationalData));
                
                closeModal();
                loadCurrentView();
                alert('✅ Entry deleted!');
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            editingKey = null;
        }

        // Skill Management
        function updateSkillList() {
            let listHTML = '';
            skillsList.forEach((skill, index) => {
                listHTML += `
                    <div class="skill-tag">
                        ${skill}
                        <button class="skill-remove" onclick="removeSkill(${index})" title="Remove skill">×</button>
                    </div>
                `;
            });
            document.getElementById('skillList').innerHTML = listHTML;
        }

        function showAddSkillModal() {
            const skillName = prompt('📝 Enter new skill name:');
            if (skillName && skillName.trim()) {
                addSkill(skillName.trim());
            }
        }

        function addSkill(skillName = null) {
            if (!skillName) {
                skillName = document.getElementById('newSkillInput').value.trim();
            }
            
            if (skillName && !skillsList.includes(skillName)) {
                skillsList.push(skillName);
                localStorage.setItem('skillsList', JSON.stringify(skillsList));
                document.getElementById('newSkillInput').value = '';
                updateSkillList();
                loadCurrentView();
                alert(`✅ "${skillName}" added successfully!`);
            } else if (skillsList.includes(skillName)) {
                alert('❌ Skill already exists!');
            } else {
                alert('❌ Please enter a skill name!');
            }
        }

        function removeSkill(index) {
            if (confirm(`🗑️ Remove "${skillsList[index]}"?`)) {
                const skillName = skillsList[index];
                skillsList.splice(index, 1);
                
                // Remove related entries
                Object.keys(operationalData).forEach(key => {
                    if (key.includes(skillName)) {
                        delete operationalData[key];
                    }
                });
                
                localStorage.setItem('skillsList', JSON.stringify(skillsList));
                localStorage.setItem('operationalData', JSON.stringify(operationalData));
                
                updateSkillList();
                loadCurrentView();
                alert('✅ Skill removed!');
            }
        }

        // Summary Cards
        function updateSummaryCards() {
            let total = 0, green = 0, amber = 0, red = 0;
            
            Object.values(operationalData).forEach(entry => {
                if (entry.landscape === currentLandscape) {
                    total++;
                    switch(entry.status) {
                        case 'green': green++; break;
                        case 'amber': amber++; break;
                        case 'red': red++; break;
                    }
                }
            });
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('greenCount').textContent = green;
            document.getElementById('amberCount').textContent = amber;
            document.getElementById('redCount').textContent = red;
        }

        // Excel Export
        function exportToExcel() {
            const weeks = generateWeeksForMonth();
            const [year, month] = currentMonth.split('-').map(Number);
            const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            let htmlTable = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <style>
                        table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
                        .header { background-color: #4472C4; color: white; font-weight: bold; text-align: center; padding: 8px; font-size: 11px; }
                        .subheader { background-color: #D9E1F2; font-weight: bold; text-align: center; padding: 6px; font-size: 10px; border: 1px solid #B4C6E7; }
                        .skill-cell { background-color: #E2EFDA; font-weight: bold; padding: 8px; font-size: 10px; border: 1px solid #A9D08E; text-align: left; }
                        .data-cell { text-align: center; padding: 8px; font-size: 12px; border: 1px solid #D0D7DE; font-weight: bold; }
                        .green-cell { background-color: #C6EFCE; color: #006100; }
                        .amber-cell { background-color: #FFEB9C; color: #9C5700; }
                        .red-cell { background-color: #FFC7CE; color: #9C0006; }
                        .white-cell { background-color: #FFFFFF; color: #767676; }
                        .status-dot { font-size: 16px; }
                    </style>
                </head>
                <body>
                    <table border="1">
                        <tr>
                            <td colspan="${weeks.length + 1}" class="header">
                                Daily Operational Communication Report Plan - ${monthName}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="${weeks.length + 1}" class="subheader">
                                Landscape: ${currentLandscape} | Report Generated: ${new Date().toLocaleDateString()} | Dynamic Downtime-Based Calculation
                            </td>
                        </tr>
                        <tr>
                            <td class="skill-cell" style="width: 250px;">Operational Description</td>
            `;
            
            weeks.forEach((week, index) => {
                htmlTable += `<td class="header" style="width: 80px;">${week.label}<br><small>${week.start}-${week.end}</small></td>`;
            });
            htmlTable += '</tr>';
            
            skillsList.forEach(skill => {
                htmlTable += `<tr><td class="skill-cell">${skill}</td>`;
                
                weeks.forEach(week => {
                    const weeklyData = calculateWeeklyStatus(skill, week.dates);
                    let cellClass = 'white-cell';
                    let statusDot = '';
                    let percentage = '';
                    
                    if (weeklyData.status !== 'none') {
                        percentage = `${weeklyData.percentage}.0%`;
                        switch(weeklyData.status) {
                            case 'green':
                                cellClass = 'green-cell';
                                statusDot = '●';
                                break;
                            case 'amber':
                                cellClass = 'amber-cell';
                                statusDot = '●';
                                break;
                            case 'red':
                                cellClass = 'red-cell';
                                statusDot = '●';
                                break;
                        }
                    } else {
                        statusDot = '○';
                        percentage = '';
                    }
                    
                    htmlTable += `
                        <td class="data-cell ${cellClass}">
                            <span class="status-dot">${statusDot}</span><br>
                            <small>${percentage}</small>
                        </td>
                    `;
                });
                
                htmlTable += '</tr>';
            });
            
            htmlTable += `
                        <tr>
                            <td colspan="${weeks.length + 1}" class="subheader">
                                Legend: ● Green (95-100%) | ● Amber (45-95%) | ● Red (0-45%) | ○ No Data - Calculated from Downtime Hours
                            </td>
                        </tr>
                    </table>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlTable], { 
                type: 'application/vnd.ms-excel;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Dynamic_Operations_Report_${currentLandscape}_${monthName.replace(' ', '_')}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('✅ Advanced Excel report exported with dynamic downtime-based calculations!');
        }

        function exportHistoryToExcel() {
            let htmlTable = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <style>
                        table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
                        .header { background-color: #4472C4; color: white; font-weight: bold; text-align: center; padding: 8px; font-size: 12px; }
                        .data-cell { text-align: center; padding: 6px; font-size: 11px; border: 1px solid #D0D7DE; }
                        .green-cell { background-color: #C6EFCE; color: #006100; }
                        .amber-cell { background-color: #FFEB9C; color: #9C5700; }
                        .red-cell { background-color: #FFC7CE; color: #9C0006; }
                    </style>
                </head>
                <body>
                    <table border="1">
                        <tr>
                            <td colspan="9" class="header">Complete Operations History Report - Dynamic Downtime-Based Calculation</td>
                        </tr>
                        <tr class="header">
                            <td>Date</td><td>Landscape</td><td>Skill</td><td>Period</td><td>Status</td><td>Performance %</td><td>Downtime (h)</td><td>Incident</td><td>Notes</td>
                        </tr>
            `;
            
            Object.entries(operationalData).forEach(([key, entry]) => {
                let cellClass = '';
                switch(entry.status) {
                    case 'green': cellClass = 'green-cell'; break;
                    case 'amber': cellClass = 'amber-cell'; break;
                    case 'red': cellClass = 'red-cell'; break;
                }
                
                htmlTable += `
                    <tr>
                        <td class="data-cell">${entry.date}</td>
                        <td class="data-cell">${entry.landscape}</td>
                        <td class="data-cell">${entry.skill}</td>
                        <td class="data-cell">${entry.period}</td>
                        <td class="data-cell ${cellClass}">● ${entry.status.toUpperCase()}</td>
                        <td class="data-cell">${entry.percentage}%</td>
                        <td class="data-cell">${entry.downtime || 0}h</td>
                        <td class="data-cell">${entry.incident || ''}</td>
                        <td class="data-cell">${entry.notes || ''}</td>
                    </tr>
                `;
            });
            
            htmlTable += '</table></body></html>';
            
            const blob = new Blob([htmlTable], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Operations_History_Dynamic_${new Date().toISOString().split('T')[0]}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('✅ Complete history exported with dynamic calculations!');
        }

        // History Management
        function showHistoryModal() {
            populateHistoryTable();
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function populateHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const filter = document.getElementById('historyFilter') ? document.getElementById('historyFilter').value : '';
            let entries = [];
            
            Object.entries(operationalData).forEach(([key, entry]) => {
                if (!filter || entry.landscape === filter) {
                    entries.push({key, ...entry});
                }
            });
            
            entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let html = '';
            entries.forEach(entry => {
                const statusColor = entry.status === 'green' ? '#28a745' : 
                                   entry.status === 'amber' ? '#ffc107' : 
                                   entry.status === 'red' ? '#dc3545' : '#999';
                
                html += `
                    <tr onclick="editHistoryEntry('${entry.key}')" style="cursor: pointer;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                        <td>${new Date(entry.timestamp).toLocaleDateString()}</td>
                        <td>${entry.landscape}</td>
                        <td>${entry.skill}</td>
                        <td>${entry.period}</td>
                        <td><span style="color: ${statusColor}; font-weight: bold; font-size: 18px;">●</span> ${entry.status}</td>
                        <td>${entry.percentage}%</td>
                        <td>${entry.downtime || 0}h</td>
                        <td>${entry.incident || '-'}</td>
                        <td>
                            <button class="edit-btn" onclick="event.stopPropagation(); editHistoryEntry('${entry.key}')">Edit</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteHistoryEntry('${entry.key}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function filterHistory() {
            populateHistoryTable();
        }

        function editHistoryEntry(key) {
            closeHistoryModal();
            const entry = operationalData[key];
            editEntry(key, entry.skill, entry.period);
        }

        function deleteHistoryEntry(key) {
            if (confirm('🗑️ Delete this history entry?')) {
                delete operationalData[key];
                localStorage.setItem('operationalData', JSON.stringify(operationalData));
                populateHistoryTable();
                loadCurrentView();
                alert('✅ Entry deleted!');
            }
        }

        // Data Management
        function clearCurrentData() {
            const confirmText = currentView === 'monthly' ? 
                `Clear all data for ${currentMonth} in ${currentLandscape}?` :
                `Clear all data for ${currentDate} in ${currentLandscape}?`;
            
            if (confirm(`🗑️ ${confirmText}`)) {
                Object.keys(operationalData).forEach(key => {
                    if (key.includes(currentLandscape)) {
                        if (currentView === 'monthly' && key.includes(currentMonth)) {
                            delete operationalData[key];
                        } else if (currentView === 'daily' && key.includes(currentDate)) {
                            delete operationalData[key];
                        }
                    }
                });
                
                localStorage.setItem('operationalData', JSON.stringify(operationalData));
                loadCurrentView();
                alert('✅ Data cleared!');
            }
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (confirm('📤 Import data? This will merge with existing data.')) {
                        operationalData = {...operationalData, ...importData.data || importData};
                        if (importData.skills) {
                            skillsList = [...new Set([...skillsList, ...importData.skills])];
                        }
                        if (importData.landscapes) {
                            landscapesList = [...new Set([...landscapesList, ...importData.landscapes])];
                            localStorage.setItem('landscapesList', JSON.stringify(landscapesList));
                            initializeLandscapes();
                        }
                        
                        localStorage.setItem('operationalData', JSON.stringify(operationalData));
                        localStorage.setItem('skillsList', JSON.stringify(skillsList));
                        
                        updateSkillList();
                        loadCurrentView();
                        alert('✅ Data imported successfully with dynamic calculations!');
                    }
                } catch (error) {
                    alert('❌ Invalid file format!');
                }
            };
            reader.readAsText(file);
        }

        // Auto-save with enhanced data
        setInterval(() => {
            if (Object.keys(operationalData).length > 0) {
                localStorage.setItem('operationalData', JSON.stringify(operationalData));
                localStorage.setItem('skillsList', JSON.stringify(skillsList));
                localStorage.setItem('landscapesList', JSON.stringify(landscapesList));
            }
        }, 30000);

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
